<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>app-router</title>
    <script src="/bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <link rel="import" href="/bower_components/polymer/polymer.html">
    <link rel="import" href="/src/app-router.html">
  </head>
  <body unresolved>
     <div style="border: 1px solid grey;">
      <h3>Polymer 1.0 OK</h3>
      <ul>
        <li>migrate to dom-module and new properties declaration</li>
        <li>set <code>notify: true</code> for the session property so that other elements are notified of property changes.</li>
        <li>use <code>this.$.router</code> instead of <code>this.querySelector('::shadow app-router')</code>
      </ul>
    </div>

    <dom-module id="user-session">
      <template>
      </template>
      <script>
      HTMLImports.whenReady(function () {
        Polymer({
          is: 'user-session',
          properties: {
            session: {
              type: Object,
              value: function () {
                console.log('user-session session value');
                return {
                  userId: null,
                  userName: null
                }
              },
              // Notify needed to have the session property bound upward to demo-app
              notify: true
            }
          },
          created: function () {
            console.log('user-session created');
          },
          attached: function () {
            console.log('user-session attached');
          },
          ready: function () {
            console.log('user-session ready');
          }

        });
      });
      </script>
    </dom-module>


    <dom-module id="login-page">
      <template>
        <button on-click="login">Log In</button>
      </template>
      <script>
        HTMLImports.whenReady(function () {
          Polymer({
            is: 'login-page',
            properties: {
              session: {
                type: Object
              },
              router: {
                type: Object
              }
            },
            login: function() {
              this.session.userId = '12345';
              this.session.userName = 'Jon Doe';
              this.router.go('/');
            }
          });
        });
       </script>
    </dom-module>


    <dom-module id="home-page">
      <template>
      <p>ID: <span>{{session.userId}}</span></p>
        <p>Name: <span>{{session.userName}}</span></p>
        <button on-click="logout">Log Out</button>
      </template>

      <script>
      HTMLImports.whenReady(function () {
        Polymer({
          is: 'home-page',
          properties: {
            session: {
              type: Object
            },
            router: {
              type: Object
            }
          },
          logout: function() {
            this.session.userId = null;
            this.session.userName = null;
            this.router.go('/');
          }
        });
      });
      </script>
    </dom-module>

    <dom-module id="demo-app">
      <template>
        <!-- bind the session object to demo-app -->
        <user-session session="{{session}}"></user-session>

        <app-router id="router" on-state-change="stateChange" init="manual">
          <app-route path="/" element="home-page" bindRouter on-before-data-binding="bindSession"></app-route>
          <app-route path="/login" element="login-page" bindRouter on-before-data-binding="bindSession"></app-route>
          <app-route path="*" redirect="/"></app-route>
        </app-router>

      </template>

      <script>
      HTMLImports.whenReady(function () {
        Polymer({
          is: 'demo-app',
          created: function () {
            console.log('demo-app created');
          },
          attached: function () {
            console.log('demo-app attached', this.session);
          },
          ready: function () {
            console.log('demo-app ready', this.session);
            this.$.router.init();

          },
          stateChange: function(event) {
            console.log('demo-app stateChange', this.session);
            // redirect to the login page if not signed in
            if (!this.session.userId && event.detail.path !== '/login') {
              event.preventDefault();
              this.$.router.go('/login');
            }
          },
          bindSession: function(event) {
            console.log('demo-app bindSession', this.session);
            // update the route's model before it's bound to the home-page or login-page
            event.detail.model.session = this.session;
          }
        });
      });
      </script>
    </dom-module>

    <demo-app></demo-app>

  </body>
</html>
